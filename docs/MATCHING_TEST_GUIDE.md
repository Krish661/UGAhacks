# SwarmAid Hybrid Matching System - Testing Guide

## ðŸŽ¯ Overview

The hybrid matching system automatically generates suggested matches when listings are posted, then allows receivers to explicitly accept matches with race-safe conditional writes.

**New Endpoints:**
- `POST /v1/matches/generate` - Manual match generation (for testing)
- `GET /v1/matches?status=SUGGESTED` - Receiver's personalized feed
- `POST /v1/matches/{matchId}/accept` - Accept a match
- `GET /v1/listings/{listingId}/matches` - Donor's interest view

---

## ðŸ” Prerequisites

```powershell
# Get token (use donor or receiver credentials)
$response = aws cognito-idp initiate-auth --auth-flow USER_PASSWORD_AUTH --client-id 1n77l3lc7ju5t8h8pgkovaqq0p --auth-parameters USERNAME="your-email@domain.com",PASSWORD="YourPassword" --profile swarmaid --region us-east-1 | ConvertFrom-Json
$token = $response.AuthenticationResult.IdToken
```

---

## ðŸ§ª Test Flow

### Step 1: Create a Listing (Using Agent)

```powershell
# Start agent session
$sessionId = [guid]::NewGuid().ToString()

# Turn 1: Initial message
$body1 = @{
    message = "I have 50 pounds of fresh apples to donate"
    sessionId = $sessionId
} | ConvertTo-Json

$response1 = Invoke-RestMethod -Method Post -Uri "https://cd2xwzhrxi.execute-api.us-east-1.amazonaws.com/prod/v1/agent/message" -Headers @{ Authorization = $token; "Content-Type" = "application/json" } -Body $body1

Write-Host "Session ID: $($response1.data.sessionId)"
Write-Host "Missing fields: $($response1.data.missingFields.Count)"

# Turn 2: Pickup time
$body2 = @{
    message = "pickup today 2-6pm"
    sessionId = $sessionId
} | ConvertTo-Json

$response2 = Invoke-RestMethod -Method Post -Uri "https://cd2xwzhrxi.execute-api.us-east-1.amazonaws.com/prod/v1/agent/message" -Headers @{ Authorization = $token; "Content-Type" = "application/json" } -Body $body2

# Turn 3: Storage
$body3 = @{
    message = "refrigerated"
    sessionId = $sessionId
} | ConvertTo-Json

$response3 = Invoke-RestMethod -Method Post -Uri "https://cd2xwzhrxi.execute-api.us-east-1.amazonaws.com/prod/v1/agent/message" -Headers @{ Authorization = $token; "Content-Type" = "application/json" } -Body $body3

# Turn 4: Pickup by
$body4 = @{
    message = "receiver picks up"
    sessionId = $sessionId
} | ConvertTo-Json

$response4 = Invoke-RestMethod -Method Post -Uri "https://cd2xwzhrxi.execute-api.us-east-1.amazonaws.com/prod/v1/agent/message" -Headers @{ Authorization = $token; "Content-Type" = "application/json" } -Body $body4

Write-Host "Complete: $($response4.data.isComplete)"

# Confirm listing
$confirmBody = @{
    sessionId = $sessionId
} | ConvertTo-Json

$confirmResponse = Invoke-RestMethod -Method Post -Uri "https://cd2xwzhrxi.execute-api.us-east-1.amazonaws.com/prod/v1/agent/confirm" -Headers @{ Authorization = $token; "Content-Type" = "application/json" } -Body $confirmBody

$listingId = $confirmResponse.data.entityId
Write-Host "Created listing: $listingId"
```

---

### Step 2: Generate Matches (Manual Trigger for Testing)

**Note:** In production, this happens automatically when listing.posted event fires. For MVP testing, we invoke directly.

```powershell
# Invoke match generation Lambda directly
$matchGenBody = @{
    listingId = $listingId
} | ConvertTo-Json

# For testing, you can invoke via AWS CLI or create an API endpoint
# For now, matches would be generated by EventBridge (not yet wired)

# Alternative: Test with AWS CLI Lambda invocation
$payload = @{
    listingId = $listingId
} | ConvertTo-Json

$payloadBase64 = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($payload))

aws lambda invoke --function-name SwarmAidFoundation-MatchGenerationLambda815887E4-XXXXX --payload $payload --profile swarmaid --region us-east-1 response.json

# Or wait for EventBridge rule (if configured)
```

---

### Step 3: View Receiver's Match Feed

Switch to receiver credentials and view their personalized feed:

```powershell
# Get receiver token
$receiverResponse = aws cognito-idp initiate-auth --auth-flow USER_PASSWORD_AUTH --client-id 1n77l3lc7ju5t8h8pgkovaqq0p --auth-parameters USERNAME="receiver@swarmaid.dev",PASSWORD="Test123!" --profile swarmaid --region us-east-1 | ConvertFrom-Json
$receiverToken = $receiverResponse.AuthenticationResult.IdToken

# Get suggested matches
$matches = Invoke-RestMethod -Method Get -Uri "https://cd2xwzhrxi.execute-api.us-east-1.amazonaws.com/prod/v1/matches?status=SUGGESTED" -Headers @{ Authorization = $receiverToken }

Write-Host "Found $($matches.data.count) suggested matches"
$matches.data.matches | Format-Table matchId, score, status

# Save first match ID for acceptance
$matchId = $matches.data.matches[0].matchId
Write-Host "Match ID to accept: $matchId"
```

---

### Step 4: Accept a Match

```powershell
# Accept the match
$acceptResponse = Invoke-RestMethod -Method Post -Uri "https://cd2xwzhrxi.execute-api.us-east-1.amazonaws.com/prod/v1/matches/$matchId/accept" -Headers @{ Authorization = $receiverToken; "Content-Type" = "application/json" }

Write-Host "Match accepted: $($acceptResponse.data.status)"
Write-Host "Listing ID: $($acceptResponse.data.listingId)"

# Verify listing status changed
$listingResponse = Invoke-RestMethod -Method Get -Uri "https://cd2xwzhrxi.execute-api.us-east-1.amazonaws.com/prod/v1/deals" -Headers @{ Authorization = $receiverToken }

$acceptedListing = $listingResponse.data.listings | Where-Object { $_.listingId -eq $acceptResponse.data.listingId }
Write-Host "Listing status: $($acceptedListing.status)" # Should be MATCHED
```

---

### Step 5: Test Race Condition (Double Accept Prevention)

Try accepting the same match with a different receiver (should fail):

```powershell
# Get another receiver token
$receiver2Response = aws cognito-idp initiate-auth --auth-flow USER_PASSWORD_AUTH --client-id 1n77l3lc7ju5t8h8pgkovaqq0p --auth-parameters USERNAME="receiver2@swarmaid.dev",PASSWORD="Test123!" --profile swarmaid --region us-east-1 | ConvertFrom-Json
$receiver2Token = $receiver2Response.AuthenticationResult.IdToken

# Try to accept same match (should fail with 409 Conflict)
try {
    $failResponse = Invoke-RestMethod -Method Post -Uri "https://cd2xwzhrxi.execute-api.us-east-1.amazonaws.com/prod/v1/matches/$matchId/accept" -Headers @{ Authorization = $receiver2Token; "Content-Type" = "application/json" }
    Write-Host "ERROR: Should have failed!"
} catch {
    $error = $_.ErrorDetails.Message | ConvertFrom-Json
    Write-Host "Expected error: $($error.error)" # Should be CONFLICT
    Write-Host "Message: $($error.message)" # "Match already accepted by someone else"
}
```

---

### Step 6: Donor Views Interest

Switch back to donor to see who accepted:

```powershell
# Get listing matches (donor view)
$interestResponse = Invoke-RestMethod -Method Get -Uri "https://cd2xwzhrxi.execute-api.us-east-1.amazonaws.com/prod/v1/listings/$listingId/matches" -Headers @{ Authorization = $token }

Write-Host "Total matches: $($interestResponse.data.totalMatches)"
Write-Host "Accepted match: $($interestResponse.data.acceptedMatch.matchId)"
Write-Host "Receiver ID: $($interestResponse.data.acceptedMatch.receiverId)"

# Show suggested matches (before acceptance)
$interestResponse.data.suggestedMatches | Format-Table matchId, receiverId, score, status
```

---

## ðŸ” Verification Checklist

- [ ] Listing created with status=POSTED
- [ ] Matches generated with status=SUGGESTED
- [ ] Receiver sees matches in their feed
- [ ] Match accept updates status to ACCEPTED
- [ ] Listing status changes to MATCHED
- [ ] Second accept fails with 409 Conflict
- [ ] Donor can see accepted match
- [ ] Match index items updated correctly

---

## ðŸ“Š Expected Data Model in DynamoDB

After running the flow, you should see:

### Match META Item
```
pk: MATCH#{matchId}
sk: META
matchId: uuid
listingId: LISTING#{id}
donorId: USER#{donorId}
receiverId: USER#{receiverId}
status: ACCEPTED
score: 85
reasons: ["Category match", "Good quantity fit", ...]
suggestedAt: 2026-02-07T19:00:00.000Z
acceptedAt: 2026-02-07T19:15:00.000Z
expiresAt: 2026-02-08T19:00:00.000Z
ttl: 1739120400
```

### Receiver Index Item
```
pk: RECEIVER#{receiverId}
sk: MATCH#ACCEPTED#015#2026-02-07T19:15:00.000Z#{matchId}
matchId: uuid
listingId: LISTING#{id}
score: 85
status: ACCEPTED
```

### Listing Index Item
```
pk: LISTING#{listingId}
sk: MATCH#ACCEPTED#015#2026-02-07T19:15:00.000Z#{matchId}
matchId: uuid
receiverId: USER#{receiverId}
score: 85
status: ACCEPTED
```

---

## ðŸ› Troubleshooting

### No matches generated
- Check if receiver profiles exist with preferences
- Verify receiver role is set to "recipient"
- Check scoring algorithm (must be >= 40 points)

### Match Generation Not Triggered
- EventBridge rule not yet configured (use manual Lambda invocation)
- listing.posted event not being emitted

### Accept Fails
- Verify match status is SUGGESTED
- Check match hasn't expired (24h window)
- Ensure receiverId matches JWT user

### Second Accept Succeeds (Should Fail)
- DynamoDB conditional update not working
- Check ConditionExpression in code

---

## ðŸš€ Next Steps

1. **Wire EventBridge Rule**: Auto-trigger match generation on listing.posted
2. **Add EventBridge Emissions**: Emit match.accepted and listing.matched events  
3. **Populate Receiver Profiles**: Add preferences and capabilities
4. **Implement Geolocation**: Add distance-based scoring
5. **Add Match Expiration**: Background Lambda to expire old matches

---

## API Endpoints Summary

| Method | Endpoint | Auth | Purpose |
|--------|----------|------|---------|
| POST | `/v1/agent/message` | Cognito | Create listing via agent |
| POST | `/v1/agent/confirm` | Cognito | Confirm listing |
| GET | `/v1/matches` | Cognito | Receiver's suggested matches |
| POST | `/v1/matches/{id}/accept` | Cognito | Accept a match |
| GET | `/v1/listings/{id}/matches` | Cognito | Donor's interest view |

**Matching system deployed and ready for testing!** ðŸŽ¯
